# 自动邮件发送工具 (Auto Email Sender)

这是一个基于 Web 界面的批量邮件发送工具，旨在帮助用户通过 Excel 或 CSV 数据文件，使用动态模板高效地发送大量个性化邮件。

## 主要功能

- **多用户管理**：支持管理员和普通用户两种角色。管理员可以管理所有配置、模板和用户。
- **动态邮件模板**：可以创建包含占位符（例如 `{{姓名}}`）的邮件主题和正文模板。
- **数据驱动发送**：上传 Excel/CSV 文件，并将文件中的列（如“姓名”、“订单号”）与模板中的占位符动态映射。
- **强大的附件支持**：
    - **通用附件**：为每一封邮件添加一个或多个相同的附件。
    - **独立附件**：为数据文件中的每一行**直接上传**一个或多个专属附件，无需处理文件路径。
    - **动态附件标签**：可选择数据文件中的一列（如“客户名”）作为附件上传区域的标签，清晰明了。
    - **特殊字符兼容**：完美支持包含中文、空格等特殊字符的附件名。
- **安全的发件人配置**：支持配置多个SMTP发件人，密码经过加密存储，并可为不同用户分配不同的发件人权限。
- **发送控制与进度反馈**：
    - **发送延迟**：可自定义每封邮件的发送间隔，有效防止因发送频率过高而被邮件服务商封禁。
    - **实时进度条**：在发送过程中实时显示发送进度，让用户对发送状态一目了然。
- **详细日志记录**：
    - 自动记录每一次的发送任务，包含每一封邮件的发送状态（成功/失败）和错误信息。
    - 自动将发送失败的条目保存到独立的CSV文件中，方便用户修正后重新发送。

## 技术栈

- **后端**: Flask (Python)
- **前端**: HTML, CSS (Bootstrap), JavaScript
- **数据库**: SQLite (通过 Flask-SQLAlchemy)
- **主要Python库**:
    - `Flask`
    - `pandas`
    - `openpyxl`
    - `Flask-SQLAlchemy`
    - `Flask-Login`
    - `cryptography`
    - `python-dotenv`

## 安装与启动

1.  **克隆仓库**
    ```bash
    git clone <your-repository-url>
    cd AutoEmailSender
    ```

2.  **创建并激活虚拟环境**
    - Windows:
      ```bash
      python -m venv venv
      .\venv\Scripts\activate
      ```
    - macOS/Linux:
      ```bash
      python3 -m venv venv
      source venv/bin/activate
      ```

3.  **安装依赖**
    ```bash
    pip install -r requirements.txt
    ```

4.  **初始化配置**
    - 复制 `.env.example` (如果存在) 或创建一个新的 `.env` 文件。该文件用于存储环境变量，但在此应用中，大部分配置通过Web界面管理。
    - 确保 `instance` 文件夹存在，如果不存在，应用首次运行时会自动创建。

5.  **初始化数据库**
    ```bash
    flask init-db
    ```

6.  **创建第一个用户**
    - 创建一个管理员用户：
      ```bash
      flask create-user <your_username> <your_password> --admin
      ```
    - 创建一个普通用户：
      ```bash
      flask create-user <your_username> <your_password>
      ```

7.  **运行应用**
    ```bash
    flask run
    ```
    应用默认将在 `http://127.0.0.1:5000` 上运行。

## 使用流程

1.  **登录**：使用您创建的用户名和密码登录。
2.  **管理员配置 (仅管理员)**：
    - **管理配置**：添加或修改SMTP发件人信息，并为用户分配权限。
    - **管理模板**：创建或编辑邮件模板，并为用户分配权限。
    - **管理用户**：添加或删除用户。
3.  **发送邮件 (主流程)**：
    - **步骤 1: 选择配置**：选择一个已授权的发件人和邮件模板。
    - **步骤 2: 上传数据**：上传包含收件人等信息的 Excel 或 CSV 文件。
    - **步骤 3: 映射字段**：将模板中的占位符（如 `{{姓名}}`）与数据文件中的列进行匹配。
    - **步骤 4: 添加附件**：
        - **独立附件 (可选)**：
            1.  从下拉菜单中选择一列（如“客户名”）来标识每一行。
            2.  为列表中的每一项**直接上传**一个或多个对应的附件。
        - **通用附件 (可选)**：上传将附加到所有邮件的通用附件。
    - **步骤 5: 确认发送**：
        - 检查所有配置是否正确。
        - 设置一个合理的**发送延迟**（建议1-5秒）。
        - 点击“确认并发送”，系统将开始在后台发送邮件，并显示实时进度。
4.  **查看日志**：发送任务完成后，您可以在 `logs` 目录下找到详细的发送日志和失败记录。